# CI/CD 工作流程文档

## 概述

本项目使用GitHub Actions实现自动化的持续集成和部署流程，确保代码质量和安全性。主要包括以下几个工作流：

1. **PR自动审阅与合并** - 针对一般的PR
2. **Main分支PR合并自动化测试** - 专门针对合并到main分支的PR
3. **Main分支保护配置** - 用于维护main分支的保护规则

## PR提交规范

为了使CI/CD系统能正确识别和处理PR，请遵循以下提交规范：

### PR标题格式

请使用[约定式提交](https://www.conventionalcommits.org/zh-hans/v1.0.0/)格式：

```
<type>[(scope)]: <description>
```

例如：

- `feat(users): 添加用户注册功能`
- `fix(articles): 修复文章列表分页bug`
- `docs: 更新README文档`

### 类型说明

- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码风格调整（不影响代码功能）
- `refactor`: 代码重构（不影响功能）
- `perf`: 性能优化
- `test`: 测试相关
- `build`: 构建系统或外部依赖变更
- `ci`: CI配置和脚本变更
- `chore`: 其他变更

## 工作流程详解

### 1. PR自动审阅与合并

**触发条件**：当PR被创建、更新、重新打开或标记时。

**主要步骤**：

1. 代码检查与测试
   - 安装依赖
   - 运行代码风格检查
   - 运行单元测试
2. 自动审阅
   - 添加评论和标签
3. 自动合并
   - 当PR被标记为"自动合并"或审阅通过时

### 2. Main分支PR合并自动化测试

**触发条件**：当针对main分支的PR被创建、更新或重新打开时。

**主要步骤**：

1. 验证PR内容与格式
   - 检查PR标题格式
   - 检查变更文件数量
2. 代码检查与测试
   - 代码风格检查
   - 单元测试与覆盖率检查
3. 安全检查
   - Bandit安全检查
   - Safety依赖检查
4. 集成测试
   - 在MySQL环境中运行集成测试
5. 自动审批与合并
   - 添加详细检查结果评论
   - 添加标签
   - 等待手动批准
   - 自动合并已批准的PR

### 3. Main分支保护配置

**触发条件**：手动触发或当相关工作流文件被更新时。

**主要步骤**：

1. 更新分支保护规则
   - 设置必须通过的状态检查
   - 设置必须的审阅数量
   - 设置代码所有者审阅要求
2. 创建CODEOWNERS文件（如果不存在）
   - 定义代码所有者

## 分支策略

本项目采用以下分支策略：

- `main`: 稳定分支，只接受经过全面测试和审阅的PR
- `develop`: 开发分支，用于集成开发中的特性
- 特性分支: 从develop分支创建，命名格式为`feature/xxx`
- 修复分支: 用于修复bug，命名格式为`fix/xxx`

## PR流程

1. 基于develop分支或特定分支创建新分支
2. 开发并提交代码
3. 创建PR，填写PR模板
4. CI自动运行测试和检查
5. 代码审阅
6. 合并到目标分支

## 标签说明

- `自动审阅通过`: PR已通过自动审阅
- `ready-for-merge`: PR已准备好合并
- `ci-passed`: PR已通过CI检查
- `自动合并`: PR可以自动合并

## 常见问题

1. **PR检查失败怎么办？**
   - 查看失败原因，修复问题后重新提交

2. **如何跳过某些检查？**
   - 特定情况下，可以使用`[skip ci]`标记提交信息，但不推荐

3. **如何处理合并冲突？**
   - 将目标分支合并到你的分支，解决冲突后重新提交

4. **审批流程是什么？**
   - 对于普通分支，需要至少一次审阅
   - 对于main分支，需要代码所有者审阅并通过所有检查
