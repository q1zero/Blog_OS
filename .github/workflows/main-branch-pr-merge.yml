name: Mainåˆ†æ”¯PRåˆå¹¶è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  validate-pr:
    name: éªŒè¯PRå†…å®¹ä¸æ ¼å¼
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: æ£€æŸ¥PRæ ‡é¢˜æ ¼å¼
        id: check-title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if ! [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?: ]]; then
            echo "PRæ ‡é¢˜æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼"
            echo "è¯·ä½¿ç”¨çº¦å®šå¼æäº¤æ ¼å¼ï¼š<type>[(scope)]: <description>"
            echo "ä¾‹å¦‚: feat(users): æ·»åŠ ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½"
            exit 1
          fi
      
      - name: æ£€æŸ¥å˜æ›´æ–‡ä»¶æ•°é‡
        id: check-files
        run: |
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | wc -l)
          echo "å˜æ›´æ–‡ä»¶æ•°é‡: $FILES_CHANGED"
          if [ $FILES_CHANGED -gt 100 ]; then
            echo "è­¦å‘Šï¼šå˜æ›´æ–‡ä»¶æ•°é‡è¾ƒå¤šï¼Œè¯·è€ƒè™‘æ‹†åˆ†PR"
            # ä¸é˜»æ­¢æµç¨‹ï¼Œä»…æç¤º
          fi
  
  lint-and-test:
    name: ä»£ç æ£€æŸ¥ä¸æµ‹è¯•
    needs: validate-pr
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: å®‰è£…uvå¹¶è®¾ç½®ç¯å¢ƒ
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv --version

      - name: å®‰è£…ä¾èµ– (uv)
        run: |
          # å®‰è£…é¡¹ç›®ä¾èµ–å’Œä»£ç æ£€æŸ¥å·¥å…·
          if [ -f "pyproject.toml" ]; then
            echo "ä½¿ç”¨pyproject.toml (uv sync) å®‰è£…é¡¹ç›®ä¾èµ–"
            uv sync
            echo "ä½¿ç”¨uv pip install å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·"
            uv pip install black isort flake8
          elif [ -f "requirements.txt" ]; then # ä½œä¸ºå¤‡é€‰ï¼Œå°½ç®¡é¡¹ç›®æœ‰pyproject.toml
            echo "ä½¿ç”¨requirements.txt (uv pip install -r) å®‰è£…ä¾èµ–"
            uv pip install -r requirements.txt
            echo "ä½¿ç”¨uv pip install å®‰è£…ä»£ç æ£€æŸ¥å·¥å…·"
            uv pip install black isort flake8
          else
            echo "æœªæ‰¾åˆ°ä¾èµ–æ–‡ä»¶ï¼Œä½¿ç”¨uv pip installç›´æ¥å®‰è£…Djangoå’Œå…¶ä»–å¿…è¦ä¾èµ–åŠå·¥å…·"
            uv pip install django djangorestframework djangorestframework-simplejwt markdown black isort flake8
          fi
          
          # ç¡®è®¤Djangoå·²å®‰è£…
          uv run python -c "import django; print(f'Djangoç‰ˆæœ¬: {django.__version__}')"
      
      - name: è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥
        id: lint
        continue-on-error: true
        run: |
          flake8 blog --count --select=E9,F63,F7,F82 --max-complexity=10 --max-line-length=127 --statistics || true
          black --check blog || true
          isort --check-only --profile black blog || true
      
      - name: è¿è¡ŒåŸºæœ¬æµ‹è¯•
        id: test
        continue-on-error: true
        run: |
          uv run python blog/manage.py check
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Djangoé¡¹ç›®æ£€æŸ¥å¤±è´¥ (lint-and-test job: blog/manage.py check)!"
            exit $EXIT_CODE
          fi
          echo "Djangoé¡¹ç›®æ£€æŸ¥é€šè¿‡ (lint-and-test job: blog/manage.py check)."

  basic-integration:
    name: åŸºæœ¬é›†æˆæµ‹è¯•
    needs: [lint-and-test]
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test_blog
          MYSQL_ROOT_PASSWORD: rootpassword
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: å®‰è£…uvå¹¶è®¾ç½®ç¯å¢ƒ
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          uv --version
      
      - name: å®‰è£…ä¾èµ– (uv)
        run: |
          # å®‰è£…é¡¹ç›®ä¾èµ–å’ŒMySQLå®¢æˆ·ç«¯
          if [ -f "pyproject.toml" ]; then
            echo "ä½¿ç”¨pyproject.toml (uv sync) å®‰è£…é¡¹ç›®ä¾èµ–"
            uv sync
            echo "ä½¿ç”¨uv pip install å®‰è£…mysqlclient"
            uv pip install mysqlclient # mysqlclient é€šå¸¸éœ€è¦å•ç‹¬å¤„ç†æˆ–åŒ…å«åœ¨é¡¹ç›®å¯é€‰ä¾èµ–ä¸­
          elif [ -f "requirements.txt" ]; then
            echo "ä½¿ç”¨requirements.txt (uv pip install -r) å®‰è£…ä¾èµ–"
            uv pip install -r requirements.txt
            echo "ä½¿ç”¨uv pip install å®‰è£…mysqlclient"
            uv pip install mysqlclient
          else
            echo "æœªæ‰¾åˆ°ä¾èµ–æ–‡ä»¶ï¼Œä½¿ç”¨uv pip installç›´æ¥å®‰è£…Djangoå’Œå…¶ä»–å¿…è¦ä¾èµ–"
            uv pip install django djangorestframework djangorestframework-simplejwt markdown mysqlclient
          fi
          
          # ç¡®è®¤Djangoå·²å®‰è£…
          uv run python -c "import django; print(f'Djangoç‰ˆæœ¬: {django.__version__}')"
      
      - name: é…ç½®æµ‹è¯•ç¯å¢ƒ
        run: |
          cd blog
          echo "SECRET_KEY=test-secret-key-for-ci" > .env
          echo "DEBUG=True" >> .env
          echo "DATABASE_URL=mysql://root:rootpassword@localhost:3306/test_blog" >> .env
      
      - name: æ£€æŸ¥Djangoé¡¹ç›®
        run: |
          uv run python blog/manage.py check
          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Djangoé¡¹ç›®æ£€æŸ¥å¤±è´¥ (basic-integration job: blog/manage.py check)!"
            exit $EXIT_CODE
          fi
          echo "Djangoé¡¹ç›®æ£€æŸ¥é€šè¿‡ (basic-integration job: blog/manage.py check)."
      
      # - name: å°è¯•è¿è¡Œæ•°æ®åº“è¿ç§»
      #   continue-on-error: true
      
      - name: éªŒè¯Djangoé¡¹ç›®èƒ½å¯åŠ¨
        run: |
          echo "å°è¯•åœ¨åå°å¯åŠ¨DjangoæœåŠ¡å™¨ (from project root, binding to 0.0.0.0:8000, skipping checks)..."
          # åœ¨åå°å¯åŠ¨æœåŠ¡å™¨ï¼Œå¹¶å°†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶ä»¥ä¾¿è°ƒè¯•
          # Log file will now be in blog/django_server.log relative to project root.
          # æ·»åŠ  --skip-checks æ¥é¿å…å› è¿ç§»çŠ¶æ€å¯¼è‡´å¯åŠ¨å¤±è´¥
          uv run python blog/manage.py runserver 0.0.0.0:8000 --skip-checks > blog/django_server.log 2>&1 &
          SERVER_PID=$!
          echo "DjangoæœåŠ¡å™¨è¿›ç¨‹PID: $SERVER_PID"
          
          echo "ç­‰å¾…20ç§’è®©æœåŠ¡å™¨å¯åŠ¨..."
          sleep 20

          echo "æ£€æŸ¥DjangoæœåŠ¡å™¨æ—¥å¿— (blog/django_server.log)..."
          if [ ! -f blog/django_server.log ]; then
            echo "!!!é”™è¯¯: DjangoæœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ blog/django_server.log æœªæ‰¾åˆ°!"
            # å³ä½¿æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿå°è¯•åˆ—å‡ºç›®å½•å†…å®¹å¸®åŠ©è°ƒè¯•
            ls -la blog/
            exit 1
          elif [ ! -s blog/django_server.log ]; then
            echo "!!!è­¦å‘Š: DjangoæœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ blog/django_server.log ä¸ºç©º!"
            # è¿™é€šå¸¸æ„å‘³ç€æœåŠ¡å™¨å¯èƒ½ç«‹å³å¤±è´¥äº†
          else
            echo "DjangoæœåŠ¡å™¨æ—¥å¿— (blog/django_server.log) å†…å®¹å‰å‡ è¡Œ:"
            head -n 30 blog/django_server.log
            # æ£€æŸ¥æ˜¯å¦æœ‰æˆåŠŸå¯åŠ¨çš„è¿¹è±¡ (å¯ä»¥æ ¹æ®å®é™…æ—¥å¿—è°ƒæ•´æ­¤grep)
            if grep -q -E "Starting development server at|Watching for file changes with" blog/django_server.log; then
              echo "æ—¥å¿—ä¸­ä¼¼ä¹åŒ…å«æœåŠ¡å™¨æˆåŠŸå¯åŠ¨çš„è¿¹è±¡ã€‚"
            else
              echo "!!!è­¦å‘Š: æ—¥å¿—ä¸­æœªæ‰¾åˆ°æ˜ç¡®çš„æœåŠ¡å™¨æˆåŠŸå¯åŠ¨ä¿¡æ¯ã€‚å¯èƒ½å¯åŠ¨å¤±è´¥ã€‚"
            fi
          fi

          echo "æ£€æŸ¥æœåŠ¡å™¨è¿›ç¨‹æ˜¯å¦ä»åœ¨è¿è¡Œ (PID: $SERVER_PID)..."
          if ! ps -p $SERVER_PID > /dev/null; then
            echo "---------------------------------------------------------------------"
            echo "!!! DjangoæœåŠ¡å™¨è¿›ç¨‹ (PID: $SERVER_PID) å·²ä¸å­˜åœ¨ã€‚å®ƒå¯èƒ½å¯åŠ¨å¤±è´¥æˆ–å·²å´©æºƒã€‚æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—è¾“å‡ºã€‚ !!!"
            echo "---------------------------------------------------------------------"
            echo "å®Œæ•´ DjangoæœåŠ¡å™¨æ—¥å¿— (blog/django_server.log) å†…å®¹:"
            cat blog/django_server.log
            exit 1
          fi

          echo "æ£€æŸ¥ç³»ç»Ÿä¸Šæ­£åœ¨ç›‘å¬çš„ç«¯å£ (å°¤å…¶æ˜¯8000)..."
          # ss é€šå¸¸åœ¨ubuntu runnerä¸­å¯ç”¨ã€‚-t TCP, -u UDP, -l listening, -n numeric, -p processes
          ss -tulnp | grep LISTEN || echo "ss å‘½ä»¤æ‰§è¡Œå¤±è´¥æˆ–æ²¡æœ‰ç›‘å¬åˆ°ä»»ä½•ç«¯å£"
          ss -tulnp | grep ':8000' || echo "æœªå‘ç°ç›‘å¬åœ¨ç«¯å£8000çš„æœåŠ¡ã€‚"

          echo "ä½¿ç”¨curl -v éªŒè¯æœåŠ¡å™¨å“åº” (http://127.0.0.1:8000)..."
          RETRY_COUNT=0
          MAX_RETRIES=5 # ä¿æŒ5æ¬¡é‡è¯•
          SUCCESS=false
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Curlå°è¯• $((RETRY_COUNT+1)) of $MAX_RETRIES..."
            # ä½¿ç”¨ -v è·å–è¯¦ç»†è¾“å‡º, -sS ä¿æŒç®€æ´ä½†æ˜¾ç¤ºé”™è¯¯, --fail ä½¿å…¶åœ¨HTTPé”™è¯¯æ—¶å¤±è´¥
            curl -v -sS --fail http://127.0.0.1:8000/
            CURL_EXIT_CODE=$?
            if [ $CURL_EXIT_CODE -eq 0 ]; then
              echo "Curlè¯·æ±‚æˆåŠŸï¼ŒæœåŠ¡å™¨å“åº”æ­£å¸¸ã€‚"
              SUCCESS=true
              break
            else
              echo "Curlè¯·æ±‚å¤±è´¥ (é€€å‡ºç : $CURL_EXIT_CODE)ï¼Œå°†åœ¨3ç§’åé‡è¯•..."
              RETRY_COUNT=$((RETRY_COUNT+1))
              sleep 3 # æ¯æ¬¡é‡è¯•é—´éš”3ç§’
            fi
          done

          echo "åœæ­¢DjangoæœåŠ¡å™¨ (PID: $SERVER_PID)..."
          kill $SERVER_PID
          # ç­‰å¾…æœåŠ¡å™¨è¿›ç¨‹å®Œå…¨åœæ­¢
          wait $SERVER_PID || echo "DjangoæœåŠ¡å™¨å·²åœæ­¢ (æˆ–ä¹‹å‰å·²åœæ­¢)ã€‚"

          if [ "$SUCCESS" = false ]; then
            echo "---------------------------------------------------------------------"
            echo "!!! DjangoæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œä½†curlè¯·æ±‚åœ¨å¤šæ¬¡é‡è¯•åä»å¤±è´¥ã€‚æŸ¥çœ‹ä¸‹é¢çš„æ—¥å¿—: !!!"
            echo "---------------------------------------------------------------------"
            echo "å®Œæ•´ DjangoæœåŠ¡å™¨æ—¥å¿— (blog/django_server.log) å†…å®¹:"
            cat blog/django_server.log
            exit 1
          fi
          echo "DjangoæœåŠ¡å™¨æˆåŠŸå¯åŠ¨å¹¶å“åº”curlè¯·æ±‚ã€‚"
  
  final-report:
    name: æµ‹è¯•ç»“æœæŠ¥å‘Š
    needs: [lint-and-test, basic-integration]
    if: success()
    runs-on: ubuntu-latest
    
    steps:
      - name: æ˜¾ç¤ºæµ‹è¯•é€šè¿‡é€šçŸ¥
        run: |
          echo "=============================================="
          echo "            ğŸ“‹ æµ‹è¯•ç»“æœæ‘˜è¦ ğŸ“‹              "
          echo "=============================================="
          echo "âœ… PRæ ¼å¼éªŒè¯é€šè¿‡"
          echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥å·²æ‰§è¡Œ"
          echo "âœ… Djangoé¡¹ç›®æ£€æŸ¥é€šè¿‡"
          echo "âœ… åŸºæœ¬é›†æˆæµ‹è¯•é€šè¿‡"
          echo "=============================================="
          echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰æµ‹è¯•å·²é€šè¿‡ ğŸ‰"
          echo "PRå°†è‡ªåŠ¨åˆå¹¶åˆ°mainåˆ†æ”¯"
          echo "=============================================="
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          echo "PRåœ°å€: $PR_URL" 
  
  auto-merge-pr:
    name: è‡ªåŠ¨åˆå¹¶PR
    needs: [final-report]
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è‡ªåŠ¨åˆå¹¶PRåˆ°mainåˆ†æ”¯
        run: |
          echo "å¼€å§‹è‡ªåŠ¨åˆå¹¶PR #${{ github.event.pull_request.number }} åˆ°mainåˆ†æ”¯..."
          
          # è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # ä½¿ç”¨GitHub CLIåˆå¹¶PR
          gh pr merge ${{ github.event.pull_request.number }} --merge
          
          echo "PR #${{ github.event.pull_request.number }} å·²æˆåŠŸåˆå¹¶åˆ°mainåˆ†æ”¯ï¼"
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }} 
